<navigation-bar bindhome="handleHome" title="参与抽奖">

  <import src="../../templates/big_list_item/big_list_item.wxml"/>

  <view class="margin30-bottom">
    <template is="big_list_item" data="{{...lottery}}"></template>
  </view>

  <view wx:if="{{lottery.status==1}}" class="margin30-bottom">
    <van-cell-group>
      <van-switch-cell
        disable="{{true}}"
        checked="{{ lottery.show_in_main }}"
        title="推荐上首页"
      >
      </van-switch-cell>
    </van-cell-group>
  </view>

  <view class="blockquote" wx:if="{{lottery.desc_initiator}}">
    <text>{{lottery.desc_initiator}}</text>
  </view>

  <view class="h-flex bg-white flex-col margin30-bottom padding30"
        wx:if="{{lottery.pic_data && lottery.pic_data.length>0}}">
    <x-richtext isReadOnly initList="{{lottery.pic_data}}"/>
  </view>

  <view wx:if="{{lottery.status == 2 && selfLuckyNum > 1 }}"
        class="bg-white margin30-bottom padding30 h-flex flex-col flex-justify-content-between">
    <view class="h6 margin15-bottom">消耗淘货点，增加中奖概率</view>
    <view class="h-flex flex-justify-content-between flex-align-center margin15-bottom">
      <view class="text-left">
        <text class="info-text">中奖概率：</text>
        <text wx:if="{{!weight_loading}}">{{weight_rate}}</text>
        <van-loading wx:else type="spinner" size="20rpx"/>
      </view>
      <van-stepper value="{{ weight }}" min="{{0}}" max="{{selfLuckyNum-1}}" integer="{{true}}"
                   show-minus="{{!lottery.hasAttended}}" input-width="58px" bind:change="onWeightChange"/>
    </view>
    <view class="h-flex flex-justify-content-between flex-align-center margin15-bottom">
      <view class="text-left"><text class="info-text">当前淘货点：</text>{{selfLuckyNum}}</view>
      <view bindtap="onShowTop">
        <van-icon wx:if="{{show_top}}" size="20px" name="arrow-down" />
        <van-icon wx:else size="20px" name="arrow" />
      </view>
    </view>
    <view class="margin30-top" wx:if="{{show_top}}">
      <view class="h-flex flex-justify-content-between padding10-30" wx:for="{{weight_top3}}" wx:key="{{index}}">
        <image class="avatar margin30-right" src="{{item.avatar_cache}}"></image>
        <view>{{item.nickname}}</view>
        <view>{{item.weight}}</view>
      </view>
    </view>
  </view>
  <view wx:else class="bg-white h-flex flex-justify-content-between padding30 margin30-bottom">
    <view>中奖权重 ：</view>
    <view class="color-gray">{{weight}}</view>
  </view>

  <form wx:if="{{lottery.status===2||lottery.status===3}}" report-submit bindsubmit="onAttend"
        class="h-flex flex-col flex-align-center bg-white margin30-bottom"
  >
    <view class="h-flex flex-center margin30">
      <view class="wave solid danger">
        <view class="circle"></view>
        <view wx:if="{{lottery.status===3}}">
          <button
            class="action__btn circle-border-radius"
            type="warn"
          >
            <text>已完成</text>
          </button>
        </view>
        <view wx:elif="{{!is_authorized}}">
          <button
            class="action__btn circle-border-radius"
            type="warn"
            open-type="getUserInfo"
            bindgetuserinfo="userInfoHandler">
            <text wx:if="{{lottery.hasAttended}}">待开奖</text>
            <text wx:else>参与抽奖</text>
          </button>
        </view>
        <button wx:else :loading="attendBtnLoading"
                form-type="submit"
                class="action__btn circle-border-radius"
                type="warn"
        >
          <text wx:if="{{lottery.hasAttended}}">待开奖</text>
          <text wx:else>参与抽奖</text>
        </button>
      </view>
    </view>
    <view class="h-flex flex-center margin30-bottom">
      <view class="action__num" bindtap="onGoToAttendees">
        已有 {{lottery.attend_num}} 人参与，查看全部
        <van-icon class="icon" name="arrow"/>
      </view>
    </view>
    <view class="h-flex flex-row width-per100 flex-center margin30-bottom">
      <image class="avatar margin30-right" wx:for="{{lottery.attend_avatar_list}}" wx:key="{{index}}"
             src="{{item}}"></image>
    </view>
  </form>

  <view class="h-flex flex-col flex-center bg-white padding30">
    <view wx:if="{{!is_authorized}}">
      <button
        class="height80 line-height80 width690"
        type="primary"
        open-type="getUserInfo"
        bindgetuserinfo="userInfoHandler">
        分享
      </button>
    </view>
    <button wx:else
            bindtap="onShare"
            class="height80 line-height80 width690 bg-dark-gray color-white"
            type="primary"
    >
      分享
    </button>
    <view class="info-text text-center padding15-top">
      邀请一个新朋友参与，就能获得100淘货点
    </view>
  </view>

  <view wx:if="{{lottery.status===1 && admin}}" class="height150 h-flex flex-justify-content-around">
    <view>
      <van-button class="bottom__btn" size="normal" bind:click="onReject">驳回</van-button>
    </view>
    <view>
      <van-button class="bottom__btn" size="normal" bind:click="onApprove" type="primary">通过</van-button>
    </view>
  </view>


  <van-popup show="{{ showSharePopup }}" position="bottom" bind:close="onCloseSharePopup" overlay="{{showSharePopup}}">

    <view class="popup">
      <view class="popup-item">
        <van-button class="popup-item-btn" icon="share" open-type="share" type="danger" hairline></van-button>
        <view>分享</view>
      </view>
      <view class="popup-item">
        <van-button class="popup-item-btn" icon="photo-o" type="danger" bindtap="genPic" hairline></van-button>
        <view>生成图片</view>
      </view>
    </view>

  </van-popup>
</navigation-bar>
<van-toast id="van-toast"/>

<poster class="poster" id="poster" hideLoading="{{true}}" preload="{{false}}" config="{{posterConfig}}"
        bind:success="onPosterSuccess" bind:fail="onPosterFail">
</poster>
